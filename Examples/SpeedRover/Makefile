DEFAULT_TARGET = linux
DEFAULT_CC = /usr/bin/gcc

# This is the name of the MagicDraw model - assumed to have the suffix .xml
CLASSNAME = Alice3_gen

# This is the state-machine name
SMNAME = Strategy
SMNAME1 = Ctrl_modes

PLATFORM := $(shell uname)
ifeq ($(PLATFORM),Darwin)
  LD_OPTS = -Wl,-all_load
else
  LD_OPTS =
endif

ifndef YAM_TARGET
  TARGET = $(DEFAULT_TARGET)
else
  TARGET = $(YAM_TARGET)
endif

ifndef CPLUSPLUS
  CC = $(DEFAULT_CC)
else
  CC = $(CPLUSPLUS)
endif

ifndef CCFLAGS
  CCFLAGS   = -m32 -std=c99 -c -g -Wall -O0  -Werror=implicit-function-declaration
endif

ifndef YAM_ROOT
   YAM_ROOT = ../..
endif

ifndef INCLUDEDIRS
INCLUDEDIRS = -I. \
              -I./autocode \
              -I../QF_C/include \
              -I /Users/shaesaert/Documents/GitHub/cvxopt_github/src/C \
              -I /anaconda/envs/Python27b/include/python2.7 \
              -I /anaconda/envs/Python27b/include

endif

ifndef LINKDIRS
  LINKDIRS = -L../QF_C/linux \
             -L/anaconda/envs/Python27b/lib

endif

ifndef APPJAR
  APPJAR = ../../autocoder/autocoder.jar
endif

BINDIR        = ./$(TARGET)

AUTOCODE =java -DDEFINE_MAIN -jar $(APPJAR) -c -sm $(SMNAME) -sm $(SMNAME1) #-sm $(12)
VPATH =

# You can have a lot of vpath directives
vpath %.c autocode
vpath %.h autocode

IMPLFILES = $(addsuffix Impl.c, $(SMNAME) $(SMNAME1)) # $(SMNAME2)

AUTOSRCS = $(addsuffix .c, $(SMNAME) $(SMNAME1)) # $(SMNAME1) $(SMNAME2)


OTHERSRCS = log_event.c \
        application.c \
	    main.c \
	    Measure.c \
	    act_impl.c \
	    cimple_controller.c \
	    cimple_gsl_library_extension.c \
	    cimple_system.c \
	    cimple_polytope_library.c \
	    cimple_c_from_py.c \
        $(IMPLFILES)

SRCS = $(OTHERSRCS) $(AUTOSRCS)

EXECUTABLE = active

AUTOGENERATED = $(addprefix autocode/, $(AUTOSRCS))

TEMPOBJS = $(notdir $(SRCS))
OBJS = $(TEMPOBJS:.c=.o)
BINOBJS = $(addprefix $(BINDIR)/, $(OBJS))

all: links auto libs bins

links:
	@if (test -d $(BINDIR)) then :;\
               else echo "Creating directory "$(BINDIR)... ; \
                      mkdir $(BINDIR); \
	fi

libs: $(BINOBJS)

bins: $(BINDIR)/$(EXECUTABLE)

autoclean:
	rm -f autocode/*

clean:
	rm -rf $(BINDIR)
	mkdir linux

test:
	echo $(IMPLFILES)

auto: $(AUTOGENERATED)

$(BINDIR)/$(EXECUTABLE) : $(BINOBJS)
	$(CC) -m32 -o $(BINDIR)/$(EXECUTABLE) $(BINOBJS) $(LINKDIRS) $(LD_OPTS) -lqf -lqep -lgsl -lgslcblas -lm -framework Python

$(BINDIR)/%.o : %.c
	$(CC) $(CCFLAGS) $(INCLUDEDIRS) $< -o $@

autocode/%.c : $(CLASSNAME).xml
		 cd autocode; \
                 $(AUTOCODE) ../$<; \
                 echo "Done Autocoding"; \
                 cd ..
